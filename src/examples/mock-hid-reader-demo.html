<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MockHIDReader Interactive Demo</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1a1a1a;
      color: #e0e0e0;
      padding: 20px;
      display: flex;
      gap: 20px;
      min-height: 100vh;
    }

    .controls {
      width: 300px;
      background: #2a2a2a;
      border-radius: 8px;
      padding: 20px;
      height: fit-content;
    }

    .main-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    h1 {
      font-size: 24px;
      margin-bottom: 20px;
      color: #fff;
    }

    h2 {
      font-size: 18px;
      margin: 20px 0 10px 0;
      color: #4fc3f7;
    }

    .canvas-container {
      background: #fff;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }

    canvas {
      display: block;
      border: 2px solid #ddd;
      border-radius: 4px;
      background: white;
      cursor: crosshair;
    }

    .status-panel {
      background: #2a2a2a;
      border-radius: 8px;
      padding: 20px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }

    .stat {
      background: #333;
      padding: 12px;
      border-radius: 6px;
      border-left: 3px solid #4fc3f7;
    }

    .stat-label {
      font-size: 12px;
      color: #999;
      margin-bottom: 4px;
    }

    .stat-value {
      font-size: 20px;
      font-weight: bold;
      color: #4fc3f7;
      font-family: 'Courier New', monospace;
    }

    button {
      width: 100%;
      padding: 10px;
      margin: 5px 0;
      background: #4fc3f7;
      border: none;
      border-radius: 6px;
      color: #000;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }

    button:hover {
      background: #81d4fa;
      transform: translateY(-1px);
    }

    button:active {
      transform: translateY(0);
    }

    button.secondary {
      background: #666;
      color: #fff;
    }

    button.secondary:hover {
      background: #777;
    }

    button.danger {
      background: #f44336;
      color: #fff;
    }

    button.danger:hover {
      background: #e57373;
    }

    .slider-group {
      margin: 15px 0;
    }

    label {
      display: block;
      font-size: 12px;
      color: #999;
      margin-bottom: 5px;
    }

    input[type="range"] {
      width: 100%;
      margin: 5px 0;
    }

    .value-display {
      font-family: 'Courier New', monospace;
      color: #4fc3f7;
      font-size: 14px;
    }

    .button-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 5px;
      margin: 10px 0;
    }

    .button-grid button {
      padding: 8px;
      font-size: 12px;
    }

    .state-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 8px;
      background: #666;
    }

    .state-indicator.active {
      background: #4caf50;
      box-shadow: 0 0 10px #4caf50;
    }

    .log {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 4px;
      padding: 10px;
      max-height: 150px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 11px;
      color: #888;
    }

    .log-entry {
      margin: 2px 0;
    }

    .log-entry.info {
      color: #4fc3f7;
    }

    .log-entry.success {
      color: #4caf50;
    }

    .log-entry.warning {
      color: #ff9800;
    }
  </style>
</head>
<body>
  <div class="controls">
    <h1>üé® MockHID Demo</h1>
    
    <h2>Device Control</h2>
    <button id="startBtn">‚ñ∂ Start Device</button>
    <button id="stopBtn" class="secondary">‚è∏ Stop Device</button>
    <button id="clearBtn" class="danger">üóë Clear Canvas</button>

    <h2>Quick Actions</h2>
    <button id="circleBtn">‚≠ï Draw Circle</button>
    <button id="spiralBtn">üåÄ Draw Spiral</button>
    <button id="squareBtn">‚¨ú Draw Square</button>

    <h2>Position</h2>
    <div class="slider-group">
      <label>X Position: <span id="xValue" class="value-display">0.50</span></label>
      <input type="range" id="xSlider" min="0" max="100" value="50">
    </div>
    <div class="slider-group">
      <label>Y Position: <span id="yValue" class="value-display">0.50</span></label>
      <input type="range" id="ySlider" min="0" max="100" value="50">
    </div>

    <h2>Pressure</h2>
    <div class="slider-group">
      <label>Pressure: <span id="pressureValue" class="value-display">0.00</span></label>
      <input type="range" id="pressureSlider" min="0" max="100" value="0">
    </div>
    <button id="contactBtn">
      <span class="state-indicator" id="contactIndicator"></span>
      Toggle Contact
    </button>

    <h2>Tilt</h2>
    <div class="slider-group">
      <label>Tilt X: <span id="tiltXValue" class="value-display">0¬∞</span></label>
      <input type="range" id="tiltXSlider" min="-60" max="60" value="0">
    </div>
    <div class="slider-group">
      <label>Tilt Y: <span id="tiltYValue" class="value-display">0¬∞</span></label>
      <input type="range" id="tiltYSlider" min="-60" max="60" value="0">
    </div>

    <h2>Stylus Buttons</h2>
    <button id="primaryBtn">Primary Button</button>
    <button id="secondaryBtn">Secondary Button</button>

    <h2>Tablet Buttons (1-8)</h2>
    <div class="button-grid">
      <button class="tablet-btn" data-button="1">1</button>
      <button class="tablet-btn" data-button="2">2</button>
      <button class="tablet-btn" data-button="3">3</button>
      <button class="tablet-btn" data-button="4">4</button>
      <button class="tablet-btn" data-button="5">5</button>
      <button class="tablet-btn" data-button="6">6</button>
      <button class="tablet-btn" data-button="7">7</button>
      <button class="tablet-btn" data-button="8">8</button>
    </div>

    <h2>Activity Log</h2>
    <div class="log" id="log"></div>
  </div>

  <div class="main-area">
    <div class="status-panel">
      <div class="stat">
        <div class="stat-label">X Position</div>
        <div class="stat-value" id="statX">0</div>
      </div>
      <div class="stat">
        <div class="stat-label">Y Position</div>
        <div class="stat-value" id="statY">0</div>
      </div>
      <div class="stat">
        <div class="stat-label">Pressure</div>
        <div class="stat-value" id="statPressure">0</div>
      </div>
      <div class="stat">
        <div class="stat-label">Tilt X</div>
        <div class="stat-value" id="statTiltX">0¬∞</div>
      </div>
      <div class="stat">
        <div class="stat-label">Tilt Y</div>
        <div class="stat-value" id="statTiltY">0¬∞</div>
      </div>
      <div class="stat">
        <div class="stat-label">State</div>
        <div class="stat-value" id="statState">hover</div>
      </div>
    </div>

    <div class="canvas-container">
      <canvas id="canvas" width="1600" height="900"></canvas>
    </div>
  </div>

  <script type="module">
    import { MockHIDReader } from '../utils/mock-hid-reader.js';
    import { Config } from '../models/index.js';

    // Canvas setup
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';

    let lastX = null;
    let lastY = null;

    // Clear canvas
    function clearCanvas() {
      ctx.fillStyle = 'white';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      lastX = null;
      lastY = null;
      addLog('Canvas cleared', 'info');
    }

    clearCanvas();

    // Logging
    function addLog(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
      logDiv.prepend(entry);
      
      // Keep only last 50 entries
      while (logDiv.children.length > 50) {
        logDiv.removeChild(logDiv.lastChild);
      }
    }

    // Load config and create mock reader
    let mockReader;
    let isRunning = false;

    async function initMockReader() {
      try {
        // Load the XP-Pen config
        const config = await Config.load('/exampleconfigurations/xp_pen_deco_640_osx_nodriver.json');
        
        mockReader = new MockHIDReader(
          { 
            mappings: config.byteCodeMappings, 
            reportId: config.reportId 
          },
          handleTabletData
        );

        addLog('MockHIDReader initialized', 'success');
      } catch (error) {
        addLog(`Error: ${error.message}`, 'warning');
      }
    }

    // Handle tablet data
    function handleTabletData(data) {
      // Update status panel
      document.getElementById('statX').textContent = Math.round(data.x || 0);
      document.getElementById('statY').textContent = Math.round(data.y || 0);
      document.getElementById('statPressure').textContent = Math.round(data.pressure || 0);
      document.getElementById('statTiltX').textContent = `${Math.round(data.tiltX || 0)}¬∞`;
      document.getElementById('statTiltY').textContent = `${Math.round(data.tiltY || 0)}¬∞`;
      document.getElementById('statState').textContent = data.state || 'unknown';

      // Draw on canvas
      if (data.state === 'contact' && data.x !== undefined && data.y !== undefined) {
        const x = (data.x / 16000) * canvas.width;
        const y = (data.y / 9000) * canvas.height;
        const pressure = (data.pressure || 0) / 16383;

        if (lastX !== null && lastY !== null) {
          // Calculate line width based on pressure (1-20px)
          const lineWidth = 1 + pressure * 19;
          
          ctx.strokeStyle = '#000';
          ctx.lineWidth = lineWidth;
          ctx.beginPath();
          ctx.moveTo(lastX, lastY);
          ctx.lineTo(x, y);
          ctx.stroke();
        }

        lastX = x;
        lastY = y;
      } else {
        lastX = null;
        lastY = null;
      }
    }

    // Control handlers
    document.getElementById('startBtn').addEventListener('click', async () => {
      if (!mockReader) await initMockReader();
      if (!isRunning) {
        await mockReader.startReading();
        isRunning = true;
        addLog('Device started', 'success');
      }
    });

    document.getElementById('stopBtn').addEventListener('click', () => {
      if (mockReader && isRunning) {
        mockReader.stop();
        isRunning = false;
        addLog('Device stopped', 'info');
      }
    });

    document.getElementById('clearBtn').addEventListener('click', clearCanvas);

    // Quick actions
    document.getElementById('circleBtn').addEventListener('click', async () => {
      if (!isRunning) return;
      addLog('Drawing circle...', 'info');
      await mockReader.drawCircle(0.5, 0.5, 0.3, 0.6, 2000);
      addLog('Circle complete', 'success');
    });

    document.getElementById('spiralBtn').addEventListener('click', async () => {
      if (!isRunning) return;
      addLog('Drawing spiral...', 'info');
      
      const steps = 100;
      const maxRadius = 0.3;
      mockReader.setState({ isContact: true });

      for (let i = 0; i <= steps; i++) {
        const t = i / steps;
        const angle = t * Math.PI * 6;
        const radius = maxRadius * t;
        const x = 0.5 + Math.cos(angle) * radius;
        const y = 0.5 + Math.sin(angle) * radius;
        const pressure = 0.3 + 0.5 * Math.sin(t * Math.PI);
        
        mockReader.setState({ x, y, pressure });
        await new Promise(resolve => setTimeout(resolve, 20));
      }

      mockReader.setState({ isContact: false, pressure: 0 });
      addLog('Spiral complete', 'success');
    });

    document.getElementById('squareBtn').addEventListener('click', async () => {
      if (!isRunning) return;
      addLog('Drawing square...', 'info');
      
      await mockReader.hoverTo(0.2, 0.2);
      await mockReader.drawLine(0.8, 0.2, 0.5, 500);
      await mockReader.drawLine(0.8, 0.8, 0.5, 500);
      await mockReader.drawLine(0.2, 0.8, 0.5, 500);
      await mockReader.drawLine(0.2, 0.2, 0.5, 500);
      
      addLog('Square complete', 'success');
    });

    // Sliders
    document.getElementById('xSlider').addEventListener('input', (e) => {
      const value = e.target.value / 100;
      document.getElementById('xValue').textContent = value.toFixed(2);
      if (mockReader) mockReader.setState({ x: value });
    });

    document.getElementById('ySlider').addEventListener('input', (e) => {
      const value = e.target.value / 100;
      document.getElementById('yValue').textContent = value.toFixed(2);
      if (mockReader) mockReader.setState({ y: value });
    });

    document.getElementById('pressureSlider').addEventListener('input', (e) => {
      const value = e.target.value / 100;
      document.getElementById('pressureValue').textContent = value.toFixed(2);
      if (mockReader) mockReader.setState({ pressure: value });
    });

    document.getElementById('tiltXSlider').addEventListener('input', (e) => {
      const value = parseInt(e.target.value);
      document.getElementById('tiltXValue').textContent = `${value}¬∞`;
      if (mockReader) mockReader.setState({ tiltX: value });
    });

    document.getElementById('tiltYSlider').addEventListener('input', (e) => {
      const value = parseInt(e.target.value);
      document.getElementById('tiltYValue').textContent = `${value}¬∞`;
      if (mockReader) mockReader.setState({ tiltY: value });
    });

    // Contact toggle
    let isContact = false;
    document.getElementById('contactBtn').addEventListener('click', () => {
      isContact = !isContact;
      document.getElementById('contactIndicator').classList.toggle('active', isContact);
      if (mockReader) {
        mockReader.setState({ isContact });
        addLog(`Contact: ${isContact ? 'ON' : 'OFF'}`, 'info');
      }
    });

    // Stylus buttons
    document.getElementById('primaryBtn').addEventListener('click', async () => {
      if (mockReader) {
        await mockReader.pressStylusButton(true, 100);
        addLog('Primary button pressed', 'info');
      }
    });

    document.getElementById('secondaryBtn').addEventListener('click', async () => {
      if (mockReader) {
        await mockReader.pressStylusButton(false, 100);
        addLog('Secondary button pressed', 'info');
      }
    });

    // Tablet buttons
    document.querySelectorAll('.tablet-btn').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const buttonNum = parseInt(e.target.dataset.button);
        if (mockReader) {
          await mockReader.pressTabletButton(buttonNum, 100);
          addLog(`Tablet button ${buttonNum} pressed`, 'info');
        }
      });
    });

    // Initialize on load
    initMockReader();
  </script>
</body>
</html>


